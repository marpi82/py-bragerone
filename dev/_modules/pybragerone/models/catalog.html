<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>pybragerone.models.catalog - pybragerone 0.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">pybragerone 0.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  <span class="sidebar-brand-text">pybragerone 0.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">pybragerone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html">pybragerone – Quick Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#tl-dr">TL;DR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#key-objects">Key Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#paramstore-modes">ParamStore Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#ha-integration-flow">HA Integration Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#parameter-semantics">Parameter Semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#entity-guidelines">Entity Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#operational-tips">Operational Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#cli-hints">CLI Hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_cheatsheet.html#parsers-ha-glue-tl-dr">Parsers + HA Glue TL;DR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html">pybragerone – Integration Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#overview">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#core-principles">Core Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#architecture-high-level">Architecture (High-Level)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#data-model-semantics">Data Model &amp; Semantics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#paramstore">ParamStore</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#eventbus">EventBus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#ha-integration-flow">HA Integration Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#entity-patterns-ha">Entity Patterns (HA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#rest-endpoints-used-by-library">REST Endpoints (used by library)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#error-handling-robustness">Error Handling &amp; Robustness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#logging-debugging">Logging &amp; Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#security-headers">Security &amp; Headers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#performance-notes">Performance Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#versioning-types">Versioning &amp; Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#cli-developer-utility">CLI (Developer Utility)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#future-work-todo">Future Work / TODO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#appendix-minimal-interfaces">Appendix: Minimal Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pybragerone_integration_notes.html#parsers-glue-integration">Parsers &amp; Glue: Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../param_store_metadata.html">Param Store Metadata Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../api.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../generated/pybragerone.api.html">pybragerone.api</a><input aria-label="Toggle navigation of pybragerone.api" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.api.client.html">pybragerone.api.client</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.api.constants.html">pybragerone.api.constants</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.api.endpoints.html">pybragerone.api.endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.api.ws.html">pybragerone.api.ws</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../generated/pybragerone.cli.html">pybragerone.cli</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../generated/pybragerone.gateway.html">pybragerone.gateway</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../generated/pybragerone.models.html">pybragerone.models</a><input aria-label="Toggle navigation of pybragerone.models" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../generated/pybragerone.models.api.html">pybragerone.models.api</a><input aria-label="Toggle navigation of pybragerone.models.api" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../generated/pybragerone.models.api.auth.html">pybragerone.models.api.auth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../generated/pybragerone.models.api.common.html">pybragerone.models.api.common</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../generated/pybragerone.models.api.modules.html">pybragerone.models.api.modules</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../generated/pybragerone.models.api.objects.html">pybragerone.models.api.objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../generated/pybragerone.models.api.system.html">pybragerone.models.api.system</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../generated/pybragerone.models.api.user.html">pybragerone.models.api.user</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.models.catalog.html">pybragerone.models.catalog</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.models.events.html">pybragerone.models.events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.models.menu.html">pybragerone.models.menu</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.models.menu_manager.html">pybragerone.models.menu_manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.models.param.html">pybragerone.models.param</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../generated/pybragerone.models.token.html">pybragerone.models.token</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../generated/pybragerone.utils.html">pybragerone.utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../new_models.html">New API Models Summary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html#id1">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pybragerone.models.catalog</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Implementation of live asset catalog parsing from BragerOne web app.</span>

<span class="sd">This module provides classes and utilities for parsing and managing live assets</span>
<span class="sd">from the BragerOne web application, including:</span>

<span class="sd">- LiveAssetsCatalog: Main entry point for fetching and parsing assets</span>
<span class="sd">- AssetRef, AssetIndex: Data structures for tracking asset references</span>
<span class="sd">- ParamMap: Data structures for menu routes and parameter mappings</span>
<span class="sd">- TranslationConfig: Configuration for available translations</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tree_sitter_javascript</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tree_sitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Language</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Parser</span><span class="p">,</span> <span class="n">Tree</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.menu</span><span class="w"> </span><span class="kn">import</span> <span class="n">MenuResult</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.menu_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">MenuManager</span><span class="p">,</span> <span class="n">RawMenuData</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..api</span><span class="w"> </span><span class="kn">import</span> <span class="n">BragerOneApiClient</span>

<span class="n">JS_LANGUAGE</span> <span class="o">=</span> <span class="n">Language</span><span class="p">(</span><span class="n">tree_sitter_javascript</span><span class="o">.</span><span class="n">language</span><span class="p">())</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ----------------------------- Data types -----------------------------</span>


<div class="viewcode-block" id="AssetRef">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.AssetRef">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AssetRef</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference to a versioned asset from the BragerOne catalog.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        url: The full URL to the asset file.</span>
<span class="sd">        base: The base name without hash (e.g., &#39;module.menu&#39; from &#39;module.menu-BNvCCsxi&#39;).</span>
<span class="sd">        hash: The hash identifier for this version (e.g., &#39;BNvCCsxi&#39;).</span>
<span class="sd">        etag: Optional ETag from HTTP headers for cache validation.</span>
<span class="sd">        last_modified: Optional last modified timestamp from HTTP headers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># BASENAME (np. &#39;module.menu-BNvCCsxi&#39; → base=&#39;module.menu&#39;)</span>
    <span class="nb">hash</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &#39;BNvCCsxi&#39;</span>
    <span class="n">etag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_modified</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="AssetIndex">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.AssetIndex">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AssetIndex</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Index of assets parsed from ``index-*.js`` file.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        assets_by_basename: Full list of assets declared in ``index-*.js`` (exact basenames, no normalization).</span>
<span class="sd">            Maps basename strings to lists of AssetRef objects.</span>
<span class="sd">        menu_map: Mapping from deviceMenu integers to BASENAME strings (e.g., ``module.menu-&lt;hash&gt;.js``).</span>
<span class="sd">        inline_param_candidates: List of (start_byte, end_byte) tuples indicating potential</span>
<span class="sd">            inline parameter maps detected within ``index-*.js``.</span>
<span class="sd">        index_bytes: Raw bytes of the index file for potential inline parsing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># full list of assets declared in index-*.js (exact basenames, no normalization)</span>
    <span class="n">assets_by_basename</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">AssetRef</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># mapping from deviceMenu:int -&gt; BASENAME(&#39;module.menu-&lt;hash&gt;.js&#39;)</span>
    <span class="n">menu_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># inline parameter maps detected within index-*.js</span>
    <span class="n">inline_param_candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># (start_byte, end_byte)</span>
    <span class="c1"># raw index for potential inline parsing</span>
    <span class="n">index_bytes</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="AssetIndex.find_asset_for_basename">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.AssetIndex.find_asset_for_basename">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_asset_for_basename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssetRef</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find an asset reference by its basename.</span>

<span class="sd">        Args:</span>
<span class="sd">            basename: The basename of the asset to search for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The last asset reference found for the given basename, or None if no</span>
<span class="sd">            asset is found. When multiple assets share the same basename, returns</span>
<span class="sd">            the last one (typically the newest hash).</span>

<span class="sd">        Note:</span>
<span class="sd">            Uses an alpha heuristic that assumes the last asset in the list is</span>
<span class="sd">            the most recent version when multiple assets share the same basename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lst</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Alpha heuristic: take the last found (usually the newest hash)</span>
        <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="AssetIndex.find_asset_for_full_name">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.AssetIndex.find_asset_for_full_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_asset_for_full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssetRef</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find an asset reference by its full name with hash (e.g., &#39;module.menu-Dbo_n32n&#39;).</span>

<span class="sd">        Args:</span>
<span class="sd">            full_name: The full name of the asset with hash to search for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The asset reference if found, or None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Search through all assets by basename to find the one with matching full name</span>
        <span class="k">for</span> <span class="n">basename_assets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">basename_assets</span><span class="p">:</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset</span><span class="o">.</span><span class="n">base</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">asset</span><span class="o">.</span><span class="n">hash</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="n">full_name</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">asset</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="ParamMap">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.ParamMap">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ParamMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a parameter mapping in the BragerOne system.</span>

<span class="sd">    This class encapsulates the mapping between parameter identifiers and their</span>
<span class="sd">    metadata, including paths, units, limits, and status flags. It serves as a</span>
<span class="sd">    structured representation of parameter configurations retrieved from the router.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        key: The unique parameter identifier token from the router.</span>
<span class="sd">            Examples: &quot;URUCHOMIENIE_KOTLA&quot;, &quot;PARAM_66&quot;.</span>
<span class="sd">        group: Optional parameter group identifier. Example: &quot;P6&quot;.</span>
<span class="sd">        paths: Dictionary mapping path types to their respective path lists.</span>
<span class="sd">            Entries are normalized lists of dictionaries describing pool/index/use</span>
<span class="sd">            metadata for value/unit/status/command/min/max channels.</span>
<span class="sd">        component_type: Optional type of the UI component associated with this parameter.</span>
<span class="sd">        units: Optional measurement unit identifier. May be a localized string, numeric</span>
<span class="sd">            code, or mapping used for enumerations; resolution happens via the units</span>
<span class="sd">            i18n catalog where possible.</span>
<span class="sd">        limits: Optional dictionary containing parameter limit definitions and constraints.</span>
<span class="sd">        status_flags: List of dictionaries defining various status flags and their meanings.</span>
<span class="sd">        origin: Source of the parameter map definition.</span>
<span class="sd">            Format: &quot;asset:&lt;url&gt;&quot; for external sources or &quot;inline:index&quot; for inline definitions.</span>
<span class="sd">        raw: The raw, unprocessed parameter map dictionary. Preserved for future use</span>
<span class="sd">            in internationalization (i18n) and logging purposes.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; param_map = ParamMap()</span>
<span class="sd">        &gt;&gt;&gt; param_map.key = &quot;PARAM_66&quot;</span>
<span class="sd">        &gt;&gt;&gt; param_map.group = &quot;P6&quot;</span>
<span class="sd">        &gt;&gt;&gt; param_map.paths = {&quot;v&quot;: [&quot;status&quot;, &quot;value&quot;], &quot;u&quot;: [&quot;status&quot;, &quot;unit&quot;]}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># token from router: np. &quot;URUCHOMIENIE_KOTLA&quot; lub &quot;PARAM_66&quot;</span>
    <span class="n">group</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>  <span class="c1"># np. &quot;P6&quot;</span>
    <span class="n">paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>  <span class="c1"># value/unit/status/command/min/max channel descriptors</span>
    <span class="n">component_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">limits</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">status_flags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">status_conditions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">command_rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># &quot;asset:&lt;url&gt;&quot; or &quot;inline:index&quot;</span>
    <span class="n">raw</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># raw map (will be useful later for i18n/logging)</span></div>



<span class="c1"># ----------------------------- Parser helpers -----------------------------</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_TS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lightweight wrapper around tree-sitter Parser for JavaScript/TypeScript.</span>

<span class="sd">    This class provides a simplified interface to the tree-sitter parser</span>
<span class="sd">    specifically configured for JavaScript language parsing.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        parser: The underlying tree-sitter Parser instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;parser&quot;</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the parser with JavaScript language support.</span>

<span class="sd">        Sets up a tree-sitter Parser instance configured to parse JavaScript</span>
<span class="sd">        and TypeScript code using the tree-sitter-javascript grammar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">JS_LANGUAGE</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse JavaScript code into an Abstract Syntax Tree (AST).</span>

<span class="sd">        Args:</span>
<span class="sd">            code: The JavaScript source code as bytes to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tree-sitter Tree object representing the parsed AST.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; parser = _TS()</span>
<span class="sd">            &gt;&gt;&gt; tree = parser.parse(b&#39;const x = 42;&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print(tree.root_node.type)</span>
<span class="sd">            program</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract text content from a tree-sitter Node.</span>

<span class="sd">    Args:</span>
<span class="sd">        code: The source code bytes the node comes from.</span>
<span class="sd">        n: The tree-sitter Node to extract text from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The decoded text content of the node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">code</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_string</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a Node represents a string literal.</span>

<span class="sd">    Args:</span>
<span class="sd">        n: The tree-sitter Node to check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the node is a string or template_string type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;template_string&quot;</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_string_value</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the value from a string literal, removing quotes.</span>

<span class="sd">    Args:</span>
<span class="sd">        text: The raw string text including quotes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The string value with surrounding quotes removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;`&quot;</span> <span class="ow">and</span> <span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_walk</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Depth-first traversal of tree-sitter Node tree.</span>

<span class="sd">    Args:</span>
<span class="sd">        node: The root node to start traversal from.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Each node in the tree in depth-first order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">cur</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cur</span><span class="o">.</span><span class="n">child_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_find_export_root</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the root export object or array in a JavaScript AST.</span>

<span class="sd">    This function implements a two-step strategy:</span>
<span class="sd">    1. Look for explicit export statements containing object/array literals</span>
<span class="sd">    2. Fall back to finding the largest object/array in the tree</span>

<span class="sd">    Args:</span>
<span class="sd">        code: The source code bytes (currently unused but kept for consistency).</span>
<span class="sd">        root: The root node of the AST to search.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The Node representing the main export object/array, or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1) export default &lt;expr&gt;</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;export_statement&quot;</span><span class="p">:</span>
            <span class="c1"># looking for object/array literal in export</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">}:</span>
                    <span class="k">return</span> <span class="n">ch</span>
    <span class="c1"># 2) fallback: largest object/array</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_sz</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">}:</span>
            <span class="n">sz</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">end_byte</span> <span class="o">-</span> <span class="n">n</span><span class="o">.</span><span class="n">start_byte</span>
            <span class="k">if</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="n">best_sz</span><span class="p">:</span>
                <span class="n">best</span><span class="p">,</span> <span class="n">best_sz</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">sz</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">bindings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an arbitrary AST node to a Python object.</span>

<span class="sd">    When *bindings* is provided, identifier nodes are resolved using the</span>
<span class="sd">    already-converted values stored in the mapping. This allows handling of the</span>
<span class="sd">    common pattern where large dictionaries reuse previously declared constants</span>
<span class="sd">    (e.g. i18n bundles exporting `const foo = &quot;label&quot;; const map = {key: foo};`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
        <span class="n">obj</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">key_node</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
            <span class="n">value_node</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key_node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">_string_value</span><span class="p">(</span><span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key_node</span><span class="p">))</span> <span class="k">if</span> <span class="n">_is_string</span><span class="p">(</span><span class="n">key_node</span><span class="p">)</span> <span class="k">else</span> <span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">key_node</span><span class="p">)</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">value_node</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">named_children</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">_is_string</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_string_value</span><span class="p">(</span><span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;.eE&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">text</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">}:</span>
        <span class="k">return</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;identifier&quot;</span><span class="p">,</span> <span class="s2">&quot;property_identifier&quot;</span><span class="p">}:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bindings</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bindings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">return</span> <span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_object_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bindings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backward-compatible wrapper around :func:`_node_to_python` for objects.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_collect_bindings</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect simple top-level bindings to resolve identifiers during conversion.&quot;&quot;&quot;</span>
    <span class="n">bindings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">statement</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;lexical_declaration&quot;</span><span class="p">,</span> <span class="s2">&quot;variable_declaration&quot;</span><span class="p">}:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">declarator</span> <span class="ow">in</span> <span class="n">statement</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">declarator</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;variable_declarator&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">name_node</span> <span class="o">=</span> <span class="n">declarator</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">value_node</span> <span class="o">=</span> <span class="n">declarator</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name_node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">name_node</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;identifier&quot;</span><span class="p">,</span> <span class="s2">&quot;property_identifier&quot;</span><span class="p">}:</span>
                <span class="k">continue</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name_node</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">value_node</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive parsing fallback</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to resolve binding &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bindings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">bindings</span>


<span class="c1"># ----------------------------- TranslationConfig -----------------------------</span>


<div class="viewcode-block" id="TranslationConfig">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.TranslationConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TranslationConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration of available translations.&quot;&quot;&quot;</span>

    <span class="n">translations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">default_translation</span><span class="p">:</span> <span class="nb">str</span></div>



<span class="c1"># ----------------------------- LiveAssetsCatalog -----------------------------</span>


<div class="viewcode-block" id="LiveAssetsCatalog">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LiveAssetsCatalog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point: fetches index-&lt;hash&gt;.js, parses router (module.menu-&lt;hash&gt;.js).</span>

<span class="sd">    Only loads necessary parameter map files (based on router tokens).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">api</span><span class="p">:</span> <span class="n">BragerOneApiClient</span><span class="p">,</span>
        <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">visibility_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;independent&quot;</span><span class="p">,</span>  <span class="c1"># &quot;independent&quot; | &quot;parent_gates_children&quot; (for future use)</span>
        <span class="n">schemas_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># hook (OFF)</span>
        <span class="n">request_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">8.0</span><span class="p">,</span>
        <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the LiveAssetsCatalog.</span>

<span class="sd">        Args:</span>
<span class="sd">            api: BragerOneApiClient used to fetch assets and index files.</span>
<span class="sd">            logger: Optional logger to use for informational and debug output.</span>
<span class="sd">            visibility_strategy: Strategy for gating menu visibility (default &#39;independent&#39;).</span>
<span class="sd">            schemas_enabled: Whether schema validation is enabled (currently unused).</span>
<span class="sd">            request_timeout: Timeout for network requests in seconds.</span>
<span class="sd">            concurrency: Maximum concurrent network operations (reserved for future use).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="n">api</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">request_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span> <span class="o">=</span> <span class="n">_TS</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="n">AssetIndex</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_index_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># New menu management system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span> <span class="o">=</span> <span class="n">MenuManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">)</span>

        <span class="c1"># Track auto-discovery attempts to help guard repeated network fetches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_autoload_attempts</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_smart_urljoin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relative_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Smart urljoin that handles assets prefix correctly to avoid double /assets/ paths.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_url: Base URL (usually an index file like /assets/index-hash.js)</span>
<span class="sd">            relative_url: Relative URL, may start with assets/</span>

<span class="sd">        Returns:</span>
<span class="sd">            Properly joined URL without duplicate /assets/ segments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>

        <span class="c1"># If relative_url starts with assets/ and base_url contains /assets/,</span>
        <span class="c1"># remove the assets/ prefix from relative_url to avoid duplication</span>
        <span class="k">if</span> <span class="n">relative_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;assets/&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;/assets/&quot;</span> <span class="ow">in</span> <span class="n">base_url</span><span class="p">:</span>
            <span class="c1"># Remove assets/ prefix</span>
            <span class="n">relative_url</span> <span class="o">=</span> <span class="n">relative_url</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>  <span class="c1"># len(&#39;assets/&#39;) = 7</span>

        <span class="k">return</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">relative_url</span><span class="p">)</span>

    <span class="c1"># ---------- lifecycle ----------</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LiveAssetsCatalog</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enter the async context manager and return self.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit the async context manager.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># ---------- INDEX ----------</span>

<div class="viewcode-block" id="LiveAssetsCatalog.refresh_index">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.refresh_index">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches index-&lt;hash&gt;.js and builds full asset index.</span>

<span class="sd">        - assets_by_basename (exact BASENAME → [AssetRef])</span>
<span class="sd">        - menu_map: int -&gt; BASENAME(module.menu-&lt;hash&gt;.js), if present in index</span>
<span class="sd">        - inline_param_candidates: list of (start,end) large objects in index that look like param-maps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">index_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_index_url</span> <span class="o">=</span> <span class="n">index_url</span>  <span class="c1"># Store for i18n URL construction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_asset_index_from_index_js</span><span class="p">(</span><span class="n">index_url</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;INDEX: assets=</span><span class="si">%d</span><span class="s2"> basenames=</span><span class="si">%d</span><span class="s2"> menus=</span><span class="si">%d</span><span class="s2"> inline_param_candidates=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">menu_map</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">inline_param_candidates</span><span class="p">),</span>
        <span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_auto_discover_and_load_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-discover and load the index file.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-discovering index file...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to discover index URL from assets page</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://one.brager.pl/assets/&quot;</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">assets_html</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>

            <span class="c1"># Look for patterns like /assets/index-XXXXXXXX.js</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/assets/(index-[A-Za-z0-9_-]+\.js)&quot;</span><span class="p">,</span> <span class="n">assets_html</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">index_filename</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">discovered_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://one.brager.pl/assets/</span><span class="si">{</span><span class="n">index_filename</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discovered index: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">discovered_url</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_index</span><span class="p">(</span><span class="n">discovered_url</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Try alternative URLs if discovery failed</span>
            <span class="n">alt_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://one.brager.pl/assets/index-main.js&quot;</span><span class="p">,</span> <span class="s2">&quot;https://one.brager.pl/assets/index.js&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">alt_urls</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trying alternative: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">alt_url</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_index</span><span class="p">(</span><span class="n">alt_url</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Success with alternative: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">alt_url</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Alternative failed: </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">alt_url</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># If all fails, log warning</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to auto-discover index file&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error auto-discovering index: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_index_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Best-effort ensure that the asset index is available.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">attempt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_autoload_attempts</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_autoload_attempts</span> <span class="o">=</span> <span class="n">attempt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Index not loaded yet. Auto-discovery attempt </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">attempt</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_discover_and_load_index</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover - should not happen but guard just in case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Auto-discovery attempt </span><span class="si">%d</span><span class="s2"> failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_asset_index_from_index_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssetIndex</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

        <span class="c1"># Performance optimization: limit regex search to first part of file for most assets</span>
        <span class="c1"># Most index files have assets declared early, but we keep a fallback for full file</span>
        <span class="n">search_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">50000</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50000</span> <span class="k">else</span> <span class="n">text</span>

        <span class="c1"># 1) Collect all &#39;*-&lt;hash&gt;.js&#39; paths from literals - SIMPLIFIED FOR PERFORMANCE</span>
        <span class="c1"># Much simpler regex that should be faster</span>
        <span class="n">assets_by_basename</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">AssetRef</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Parameters and i18n assets frequently live deeper in the bundle, so we scan both the</span>
        <span class="c1"># leading slice and the remaining part. We also normalise basenames to strip path prefixes.</span>
        <span class="n">simple_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([A-Za-z0-9._/-]+?)-([A-Za-z0-9_-]+)\.js&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_register</span><span class="p">(</span><span class="n">matches</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">raw_base</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Normalise &#39;../parameters/write/FOO&#39; → &#39;FOO&#39;</span>
                <span class="n">norm_base</span> <span class="o">=</span> <span class="n">raw_base</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">full_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smart_urljoin</span><span class="p">(</span><span class="n">index_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">raw_base</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">.js&quot;</span><span class="p">)</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">assets_by_basename</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">norm_base</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">hash</span> <span class="o">!=</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">existing</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">full_url</span> <span class="k">for</span> <span class="n">existing</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">):</span>
                    <span class="n">bucket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AssetRef</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">full_url</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">norm_base</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">h</span><span class="p">))</span>

        <span class="n">_register</span><span class="p">(</span><span class="n">simple_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">search_text</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_text</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scanning remaining index fragment for additional assets...&quot;</span><span class="p">)</span>
            <span class="n">_register</span><span class="p">(</span><span class="n">simple_pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">search_text</span><span class="p">)</span> <span class="p">:]))</span>

        <span class="c1"># 2) Try to find mapping from deviceMenu:int -&gt; &#39;module.menu-&lt;hash&gt;.js&#39; in index (Regex fallback)</span>
        <span class="c1"># Use regex pattern matching since AST parsing fails on complex minified code in Object.assign</span>
        <span class="n">menu_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Look for deviceMenu patterns in Object.assign calls</span>
            <span class="c1"># Pattern: &quot;../../config/router/deviceMenu/N/module.menu.ts&quot;:()=&gt;d(()=&gt;import(&quot;./module.menu-HASH.js&quot;)</span>
            <span class="n">device_menu_pattern</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;&quot;\.\.\/\.\.\/config\/router\/deviceMenu\/(\d+)\/module\.menu\.ts&quot;:\(\)\=\&gt;d&#39;</span>
                <span class="sa">r</span><span class="s1">&#39;\(\(\)\=\&gt;import\(&quot;\./(module\.menu-[A-Za-z0-9_]+)\.js&quot;\)&#39;</span>
            <span class="p">)</span>

            <span class="c1"># Ensure code is a string for regex</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">code_str</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytearray</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">)):</span>
                <span class="n">code_str</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">device_menu_pattern</span><span class="p">,</span> <span class="n">code_str</span><span class="p">):</span>
                <span class="n">device_menu_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">menu_file_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">menu_map</span><span class="p">[</span><span class="n">device_menu_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">menu_file_name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found deviceMenu mapping: </span><span class="si">%d</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_menu_num</span><span class="p">,</span> <span class="n">menu_file_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">regex_e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Regex deviceMenu parsing failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">regex_e</span><span class="p">)</span>

        <span class="c1"># Prepare limited code for AST parsing (needed for inline param candidates)</span>
        <span class="n">ast_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
        <span class="n">limited_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">[:</span><span class="n">ast_limit</span><span class="p">]</span>

        <span class="c1"># 3) Inline param-map candidates (AST on limited data)</span>
        <span class="n">inline_candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_code</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Reuse tree if available, or parse again for param candidates</span>
                <span class="k">if</span> <span class="s2">&quot;tree&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">limited_code</span><span class="p">)</span>

                <span class="n">objects_checked</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">max_param_objects</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># More objects for param search</span>

                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_walk</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">objects_checked</span> <span class="o">&lt;</span> <span class="n">max_param_objects</span><span class="p">:</span>
                        <span class="n">objects_checked</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">approx_len</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">end_byte</span> <span class="o">-</span> <span class="n">n</span><span class="o">.</span><span class="n">start_byte</span>
                        <span class="k">if</span> <span class="n">approx_len</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># heuristic: larger objects are more likely to be maps</span>
                            <span class="c1"># quick &quot;shape&quot; of param-map: look for keywords inside</span>
                            <span class="n">obj_start</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">start_byte</span>
                            <span class="n">obj_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">end_byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_code</span><span class="p">))</span>
                            <span class="n">snippet</span> <span class="o">=</span> <span class="n">limited_code</span><span class="p">[</span><span class="n">obj_start</span><span class="p">:</span><span class="n">obj_end</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                                <span class="n">key</span> <span class="ow">in</span> <span class="n">snippet</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;pool&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;use&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;componentType&quot;</span><span class="p">)</span>
                            <span class="p">):</span>
                                <span class="n">inline_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj_start</span><span class="p">,</span> <span class="n">obj_end</span><span class="p">))</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">param_e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Param candidates AST parsing failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">param_e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">AssetIndex</span><span class="p">(</span>
            <span class="n">assets_by_basename</span><span class="o">=</span><span class="n">assets_by_basename</span><span class="p">,</span>
            <span class="n">menu_map</span><span class="o">=</span><span class="n">menu_map</span><span class="p">,</span>
            <span class="n">inline_param_candidates</span><span class="o">=</span><span class="n">inline_candidates</span><span class="p">,</span>
            <span class="n">index_bytes</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ---------- MENU ----------</span>

<div class="viewcode-block" id="LiveAssetsCatalog.get_module_menu">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.get_module_menu">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_module_menu</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_menu</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">permissions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">debug_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MenuResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get processed menu using the unified MenuManager pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">device_menu</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">list_cached_menus</span><span class="p">():</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_and_cache_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="p">)</span>

        <span class="n">perm_set</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">permissions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">permissions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">get_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="o">=</span><span class="n">device_menu</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="n">perm_set</span><span class="p">,</span> <span class="n">debug_mode</span><span class="o">=</span><span class="n">debug_mode</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_load_and_cache_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_menu</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load raw menu data and cache it in MenuManager.&quot;&quot;&quot;</span>
        <span class="c1"># Auto-load index if not loaded yet</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">menu_map</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_discover_and_load_index</span><span class="p">()</span>

        <span class="c1"># Find asset for device_menu</span>
        <span class="n">menu_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">menu_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">device_menu</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">menu_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No menu mapping found for device_menu=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_menu</span><span class="p">)</span>
            <span class="c1"># Cache empty menu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">store_raw_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Get asset reference</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">find_asset_for_full_name</span><span class="p">(</span><span class="n">menu_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asset</span><span class="p">:</span>
            <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">find_asset_for_basename</span><span class="p">(</span><span class="s2">&quot;module.menu&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">asset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No menu asset found for device_menu=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">device_menu</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">store_raw_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="p">,</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Fetch and parse menu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading menu asset: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># Parse raw routes (no filtering, no processing)</span>
        <span class="n">raw_routes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_menu_routes</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="c1"># Store in cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">store_raw_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="o">=</span><span class="n">device_menu</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="n">raw_routes</span><span class="p">,</span> <span class="n">asset_url</span><span class="o">=</span><span class="n">asset</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cached raw menu for device_menu=</span><span class="si">%d</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> routes&quot;</span><span class="p">,</span> <span class="n">device_menu</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_routes</span><span class="p">))</span>

<div class="viewcode-block" id="LiveAssetsCatalog.get_raw_menu">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.get_raw_menu">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_raw_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_menu</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMenuData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get raw unprocessed menu data for debugging.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">get_raw_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="p">)</span></div>


<div class="viewcode-block" id="LiveAssetsCatalog.get_menu_debug_info">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.get_menu_debug_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_menu_debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_menu</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get debug information about cached menu.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_menu_manager</span><span class="o">.</span><span class="n">get_debug_info</span><span class="p">(</span><span class="n">device_menu</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_menu_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returning list of root-routes (1:1 with export in module.menu-*.js).&quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">bindings</span> <span class="o">=</span> <span class="n">_collect_bindings</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">_find_export_root</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">export_obj</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">extract_routes</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)]</span>
                <span class="n">meaningful</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">candidates</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">,</span> <span class="s2">&quot;meta&quot;</span><span class="p">))]</span>
                <span class="k">return</span> <span class="n">meaningful</span> <span class="ow">or</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;routes&quot;</span><span class="p">,</span> <span class="s2">&quot;deviceMenu&quot;</span><span class="p">,</span> <span class="s2">&quot;menu&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">extracted</span> <span class="o">=</span> <span class="n">extract_routes</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">extracted</span>
                <span class="k">for</span> <span class="n">nested</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">extracted</span> <span class="o">=</span> <span class="n">extract_routes</span><span class="p">(</span><span class="n">nested</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">extracted</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">raw_routes</span> <span class="o">=</span> <span class="n">extract_routes</span><span class="p">(</span><span class="n">export_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_attach_parameters_tokens</span><span class="p">(</span><span class="n">route</span><span class="p">)</span> <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">raw_routes</span><span class="p">]</span>

    <span class="n">PARAM_CALL_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;[A-Za-z]\([^,]*?,\s*([&#39;&quot;])(?P&lt;tok&gt;[^&#39;&quot;]+)\1\)&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_attach_parameters_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach parameter tokens to a node by processing its parameters section.</span>

<span class="sd">        After AST to dict conversion, items in parameters.* sections can be:</span>
<span class="sd">        - Literal strings (already valid tokens)</span>
<span class="sd">        - Call expressions as raw strings, e.g., &quot;E(A.WRITE,&#39;URUCHOMIENIE_KOTLA&#39;)&quot;</span>
<span class="sd">            from which we extract the token using regex</span>

<span class="sd">        This method processes all parameter sections (read, write, status, special),</span>
<span class="sd">        extracts tokens from various formats, and normalizes them into a consistent</span>
<span class="sd">        dict structure with a &quot;token&quot; key. It recursively processes child nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">                node: A dictionary representing a catalog node that may contain a</span>
<span class="sd">                        &quot;parameters&quot; section with read/write/status/special subsections,</span>
<span class="sd">                        and optionally a &quot;children&quot; list.</span>

<span class="sd">        Returns:</span>
<span class="sd">                A new dictionary with the same structure as the input node, but with</span>
<span class="sd">                parameters normalized to dicts containing &quot;token&quot; keys, and children</span>
<span class="sd">                recursively processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">newp</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">,</span> <span class="s2">&quot;write&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;special&quot;</span><span class="p">):</span>
                <span class="n">items</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="n">norm</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">original</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAM_CALL_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                            <span class="n">tok</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;tok&quot;</span><span class="p">)</span>
                            <span class="n">norm</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">tok</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">original</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">norm</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">original</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">original</span><span class="p">})</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">entry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                        <span class="n">param_value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameter&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAM_CALL_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="s2">&quot;token&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;tok&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s2">&quot;token&quot;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                            <span class="n">token_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">])</span>
                            <span class="n">entry</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="n">token_val</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fallback_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAM_CALL_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fallback_text</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;tok&quot;</span><span class="p">)</span>
                                <span class="n">entry</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;parameter&quot;</span><span class="p">,</span> <span class="n">fallback_text</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;parameter&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="s2">&quot;token&quot;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                            <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;parameter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PARAM_CALL_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                            <span class="n">tok</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;tok&quot;</span><span class="p">)</span>
                            <span class="n">norm</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">tok</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="n">s</span><span class="p">:</span>
                            <span class="n">norm</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span>
                <span class="n">newp</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newp</span>
        <span class="c1"># recursion for children</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_attach_parameters_tokens</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Fix: If children exists but is not a list (e.g., string reference like &#39;wA&#39;),</span>
            <span class="c1"># convert to empty list to prevent MenuManager errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting non-list children to empty list: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="c1"># ---------- PARAM MAPS ----------</span>

<div class="viewcode-block" id="LiveAssetsCatalog.get_param_mapping">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.get_param_mapping">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_param_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ParamMap</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve parameter mappings for the given tokens.</span>

<span class="sd">        This method attempts to resolve parameter mappings for each provided token through</span>
<span class="sd">        a two-stage resolution process:</span>

<span class="sd">        1. First, it searches for a dedicated asset file named ``BASENAME-&lt;hash&gt;.js`` where</span>
<span class="sd">           BASENAME exactly matches the token.</span>
<span class="sd">        2. If no asset is found, and there is exactly one unresolved token with exactly</span>
<span class="sd">           one inline parameter candidate in the index, it attempts to use the inline</span>
<span class="sd">           parameter map from the ``index-*.js`` file as a fallback.</span>
<span class="sd">        3. Any tokens that cannot be resolved through either method are omitted from</span>
<span class="sd">           the results.</span>

<span class="sd">        Args:</span>
<span class="sd">             tokens: An iterable of token strings to resolve into parameter mappings.</span>

<span class="sd">        Returns:</span>
<span class="sd">             A dictionary mapping successfully resolved token strings to their</span>
<span class="sd">             corresponding ParamMap objects. Only tokens that were successfully</span>
<span class="sd">             resolved are included in the returned dictionary.</span>

<span class="sd">        Note:</span>
<span class="sd">             The method performs asset fetching concurrently using asyncio.gather for</span>
<span class="sd">             improved performance. Failed fetches are logged but do not raise exceptions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uniq_tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">t</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">assets_by_basename</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_index_loaded</span><span class="p">()</span>

        <span class="c1"># 1) file assets</span>
        <span class="n">file_jobs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssetRef</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unresolved</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">uniq_tokens</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">find_asset_for_basename</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
                <span class="n">file_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tok</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unresolved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span>

        <span class="n">results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ParamMap</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_and_parse</span><span class="p">(</span><span class="n">tok</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">AssetRef</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_param_map_from_js</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;asset:</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pm</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PARAM MAP not found in asset (export not object?): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Param asset fetch failed </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">fetch_and_parse</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">tok</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">file_jobs</span><span class="p">),</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># 2) inline fallback — only if index has exactly 1 candidate and 1 unresolved token</span>
        <span class="k">if</span> <span class="n">unresolved</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">unresolved</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">inline_param_candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">unresolved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">inline_param_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_param_map_from_js</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">tok</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;inline:index&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pm</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">tok</span><span class="p">]</span> <span class="o">=</span> <span class="n">pm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Inline param candidate didn&#39;t parse as expected for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tok</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;PARAM MAPS: tokens=</span><span class="si">%d</span><span class="s2"> resolved=</span><span class="si">%d</span><span class="s2"> unresolved=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_tokens</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniq_tokens</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_param_map_from_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParamMap</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a JavaScript file (or index fragment) and extract a parameter map object.</span>

<span class="sd">        This method analyzes JavaScript code to find and parse an exported object that</span>
<span class="sd">        appears to be a parameter map. It extracts various fields like group, paths,</span>
<span class="sd">        component type, units, limits, and status flags, performing minimal normalization</span>
<span class="sd">        on the data structure.</span>

<span class="sd">        Args:</span>
<span class="sd">            code: The JavaScript source code as bytes to parse.</span>
<span class="sd">            key: A string identifier for this parameter map.</span>
<span class="sd">            origin: A string indicating the source/origin of this parameter map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A ParamMap object containing the parsed and normalized parameter data,</span>
<span class="sd">            or None if no valid parameter map could be extracted from the code.</span>

<span class="sd">        Note:</span>
<span class="sd">            The method performs minimal normalization by checking for alternative field</span>
<span class="sd">            names (e.g., &#39;group&#39; or &#39;pool&#39;, &#39;use&#39; fields or direct &#39;value&#39;/&#39;unit&#39;/&#39;status&#39;).</span>
<span class="sd">            The raw parsed object is preserved in the ParamMap&#39;s &#39;raw&#39; attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">_find_export_root</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">_object_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">group</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pool&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_mapping_list</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_status</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
            <span class="n">conditions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">flat</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">raw_key</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw_key</span><span class="p">)</span>
                    <span class="n">normalized_entries</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">normalized_entries</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">conditions</span><span class="p">[</span><span class="n">key_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_entries</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">normalized_entries</span><span class="p">:</span>
                        <span class="n">enriched</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                        <span class="n">enriched</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">key_str</span><span class="p">)</span>
                        <span class="n">flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enriched</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">normalized_entries</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">normalized_entries</span><span class="p">:</span>
                    <span class="n">conditions</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_entries</span>
                    <span class="n">flat</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normalized_entries</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">flat</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_literal</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">trimmed</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trimmed</span> <span class="o">==</span> <span class="s2">&quot;void 0&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">trimmed</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">trimmed</span> <span class="o">==</span> <span class="s2">&quot;!0&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">trimmed</span> <span class="o">==</span> <span class="s2">&quot;!1&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_identifier</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cleaned</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="n">cleaned</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">}:</span>
                <span class="n">cleaned</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cleaned</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_condition_entries</span><span class="p">(</span><span class="n">entries</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="n">conditions_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">conditions_list</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;operation&quot;</span><span class="p">:</span> <span class="n">_normalize_identifier</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operation&quot;</span><span class="p">)),</span>
                    <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">_normalize_literal</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;expected&quot;</span><span class="p">)),</span>
                    <span class="s2">&quot;targets&quot;</span><span class="p">:</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)),</span>
                <span class="p">}</span>
                <span class="n">conditions_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">conditions_list</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_command_action</span><span class="p">(</span><span class="n">raw_action</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_action</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">_normalize_identifier</span><span class="p">(</span><span class="n">raw_action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_normalize_literal</span><span class="p">(</span><span class="n">raw_action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
            <span class="n">action</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
                <span class="n">action</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">action</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">action</span> <span class="k">if</span> <span class="n">action</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_command_branches</span><span class="p">(</span><span class="n">blocks</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">logic_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
            <span class="n">normalized</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">normalized</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">branch_key</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;elseif&quot;</span><span class="p">,</span> <span class="s2">&quot;else&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                        <span class="n">branch_key</span> <span class="o">=</span> <span class="n">candidate</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">branch_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">branch_key</span> <span class="o">=</span> <span class="s2">&quot;if&quot;</span>
                <span class="n">conditions</span> <span class="o">=</span> <span class="n">_normalize_condition_entries</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">branch_key</span><span class="p">))</span> <span class="k">if</span> <span class="n">branch_key</span> <span class="o">!=</span> <span class="s2">&quot;else&quot;</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="n">action_source</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;then&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">branch_key</span> <span class="o">!=</span> <span class="s2">&quot;else&quot;</span> <span class="k">else</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;else&quot;</span><span class="p">)</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">_normalize_command_action</span><span class="p">(</span><span class="n">action_source</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">normalized_entry</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;logic&quot;</span><span class="p">:</span> <span class="n">logic_key</span><span class="p">,</span>
                    <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">branch_key</span><span class="p">,</span>
                    <span class="s2">&quot;conditions&quot;</span><span class="p">:</span> <span class="n">conditions</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">normalized_entry</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized_entry</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">normalized</span>

        <span class="n">value_paths</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">))</span>
        <span class="n">unit_paths</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">))</span>
        <span class="n">command_paths</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;command&quot;</span><span class="p">))</span>
        <span class="n">min_paths</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minValue&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">))</span>
        <span class="n">max_paths</span> <span class="o">=</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxValue&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">))</span>
        <span class="n">status_conditions</span><span class="p">,</span> <span class="n">status_flat</span> <span class="o">=</span> <span class="n">_normalize_status</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">))</span>

        <span class="n">command_rules</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">logic_key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;when&quot;</span><span class="p">):</span>
            <span class="n">command_rules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_normalize_command_branches</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">logic_key</span><span class="p">),</span> <span class="n">logic_key</span><span class="p">))</span>

        <span class="n">use</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">value_paths</span> <span class="o">=</span> <span class="n">value_paths</span> <span class="ow">or</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">))</span>
            <span class="n">unit_paths</span> <span class="o">=</span> <span class="n">unit_paths</span> <span class="ow">or</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status_flat</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">status_flat</span> <span class="o">=</span> <span class="n">_normalize_status</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">))</span>
            <span class="n">min_paths</span> <span class="o">=</span> <span class="n">min_paths</span> <span class="ow">or</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">))</span>
            <span class="n">max_paths</span> <span class="o">=</span> <span class="n">max_paths</span> <span class="ow">or</span> <span class="n">_ensure_mapping_list</span><span class="p">(</span><span class="n">use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">))</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value_paths</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">unit_paths</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status_flat</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command_paths</span><span class="p">,</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">min_paths</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">max_paths</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;componentType&quot;</span><span class="p">)</span>
        <span class="n">units_raw</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;units&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unit_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;limits&quot;</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="s2">&quot;minmax&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">obj</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">cand</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">limits</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">cand</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="n">status_flags</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;statusFlags&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status_bits&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">ParamMap</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="n">group</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">paths</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span>
            <span class="n">component_type</span><span class="o">=</span><span class="n">component</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units_raw</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">units_raw</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
            <span class="n">status_flags</span><span class="o">=</span><span class="n">status_flags</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status_flags</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="n">status_conditions</span><span class="o">=</span><span class="n">status_conditions</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">command_rules</span><span class="o">=</span><span class="n">command_rules</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
            <span class="n">raw</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># ---------- Permissions helper ----------</span>

<div class="viewcode-block" id="LiveAssetsCatalog.list_symbols_for_permissions">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.list_symbols_for_permissions">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_symbols_for_permissions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device_menu</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">permissions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List symbols visible for given permissions.</span>

<span class="sd">        This is a convenient shortcut that fetches the menu for device_menu and returns</span>
<span class="sd">        tokens visible for the provided permissions. The schemas hook remains OFF.</span>

<span class="sd">        Args:</span>
<span class="sd">            device_menu: The device menu identifier.</span>
<span class="sd">            permissions: An iterable of permission strings to check visibility against.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A set of token strings that are visible for the given permissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_module_menu</span><span class="p">(</span><span class="n">device_menu</span><span class="o">=</span><span class="n">device_menu</span><span class="p">,</span> <span class="n">permissions</span><span class="o">=</span><span class="n">permissions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">menu</span><span class="o">.</span><span class="n">all_tokens</span><span class="p">()</span></div>


    <span class="c1"># ---------- i18n support ----------</span>

<div class="viewcode-block" id="LiveAssetsCatalog.list_language_config">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.list_language_config">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_language_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TranslationConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get translation configuration from assets.</span>

<span class="sd">        Parses the ``index-*.js`` file to extract language configuration by structural patterns.</span>
<span class="sd">        The configuration object contains translations array and defaultTranslation field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_index_loaded</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No index data available. Call refresh_index() or refresh_index_minimal() first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_language_config_from_js</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse language config from index: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="LiveAssetsCatalog.get_i18n">
<a class="viewcode-back" href="../../../generated/pybragerone.models.catalog.html#pybragerone.models.LiveAssetsCatalog.get_i18n">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_i18n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get i18n mapping for a given language and namespace.</span>

<span class="sd">        Parses the index file for dynamic language imports in the format:</span>
<span class="sd">        &quot;../../resources/languages/{lang}/{namespace}.json&quot;:()=&gt;d(()=&gt;import(&quot;./file-hash.js&quot;),[]).then(e=&gt;e.default)</span>

<span class="sd">        Then fetches and parses the corresponding asset file.</span>

<span class="sd">        Args:</span>
<span class="sd">            lang: Language code (e.g., &#39;en&#39;, &#39;pl&#39;).</span>
<span class="sd">            namespace: Namespace (e.g., &#39;parameters&#39;, &#39;units&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with translation mappings, or empty dict if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_index_loaded</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No index data available for i18n lookup&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Find the asset for this specific language/namespace combination</span>
            <span class="n">asset_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_i18n_asset</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">asset_ref</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No i18n asset found for </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="c1"># Fetch and parse the i18n file</span>
            <span class="n">code</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">asset_ref</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_i18n_from_js</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loaded i18n </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> keys&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">translations</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">translations</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to load i18n </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_find_i18n_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssetRef</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find i18n asset for given language and namespace.</span>

<span class="sd">        Looks for patterns in index like:</span>
<span class="sd">        &quot;../../resources/languages/{lang}/{namespace}.json&quot;:()=&gt;d(()=&gt;import(&quot;./file-hash.js&quot;),[])</span>

<span class="sd">        Args:</span>
<span class="sd">            lang: Language code.</span>
<span class="sd">            namespace: Namespace (e.g., &#39;parameters&#39;, &#39;units&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            AssetRef for the i18n file or None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">index_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">index_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

        <span class="c1"># Pattern to match: &quot;../../resources/languages/{lang}/{namespace}.json&quot;:()=&gt;d(()=&gt;import(&quot;./filename-hash.js&quot;)</span>
        <span class="c1"># We need to extract the import file path and hash</span>
        <span class="n">import_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">rf</span><span class="s1">&#39;[&quot;</span><span class="se">\&#39;</span><span class="s1">]\.\.\/\.\.\/resources\/languages\/</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span><span class="si">}</span><span class="s1">\/</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span><span class="si">}</span><span class="s1">\.json[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;:\s*\(\)\s*=&gt;\s*\w+\s*\(\s*\(\)\s*=&gt;\s*import\s*\(\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]\.\/([^&quot;</span><span class="se">\&#39;</span><span class="s1">]+)-([A-Za-z0-9_]+)\.js[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span>
        <span class="p">)</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">import_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">index_text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No i18n asset pattern match for </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">. Pattern: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">import_pattern</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">file_base</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># e.g., &quot;parameters&quot;</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># e.g., &quot;BNvCCsxi&quot;</span>

        <span class="c1"># Construct the full asset filename and URL</span>
        <span class="n">asset_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_base</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">file_hash</span><span class="si">}</span><span class="s2">.js&quot;</span>

        <span class="c1"># Look up the asset in our index by basename</span>
        <span class="c1"># The basename should match the file_base (e.g., &quot;parameters&quot;)</span>
        <span class="n">asset_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idx</span><span class="o">.</span><span class="n">find_asset_for_basename</span><span class="p">(</span><span class="n">file_base</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asset_ref</span> <span class="ow">and</span> <span class="n">asset_ref</span><span class="o">.</span><span class="n">hash</span> <span class="o">==</span> <span class="n">file_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">asset_ref</span>

        <span class="c1"># Fallback: construct URL based on index URL pattern</span>
        <span class="c1"># This assumes the i18n files are in the same directory as the index</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_last_index_url&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_index_url</span><span class="p">:</span>
            <span class="n">asset_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smart_urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_index_url</span><span class="p">,</span> <span class="n">asset_filename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">AssetRef</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">asset_url</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">file_base</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">file_hash</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_i18n_from_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse i18n translations from a JavaScript module.</span>

<span class="sd">        Expected format:</span>
<span class="sd">        export default { &quot;key1&quot;: &quot;value1&quot;, &quot;key2&quot;: &quot;value2&quot;, ... }</span>

<span class="sd">        Args:</span>
<span class="sd">            code: JavaScript source code bytes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of translations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">root_node</span>
            <span class="n">code_text</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

            <span class="n">bindings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Collect constant bindings so we can resolve identifier references</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;lexical_declaration&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">declarator</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">declarator</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;variable_declarator&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">name_node</span> <span class="o">=</span> <span class="n">declarator</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="n">value_node</span> <span class="o">=</span> <span class="n">declarator</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name_node</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">_node_text</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name_node</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">bindings</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">value_node</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>

            <span class="n">translations</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Prefer explicit `export default &lt;expr&gt;` if present.</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">named_children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;export_statement&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">translations</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">value_node</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">translations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;export\s*\{[^}]*?([A-Za-z0-9_$]+)\s+as\s+default&quot;</span><span class="p">,</span>
                    <span class="n">code_text</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">default_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">bindings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">candidate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">translations</span> <span class="o">=</span> <span class="n">candidate</span>

            <span class="k">if</span> <span class="n">translations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">export_root</span> <span class="o">=</span> <span class="n">_find_export_root</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">export_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">translations</span> <span class="o">=</span> <span class="n">_node_to_python</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">export_root</span><span class="p">,</span> <span class="n">bindings</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">translations</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">translations</span>

            <span class="k">if</span> <span class="n">translations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;i18n export is not an object: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">translations</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse i18n JavaScript: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_language_config_from_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TranslationConfig</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse language configuration from JavaScript code using tree-sitter.</span>

<span class="sd">        Looks for language configuration objects with translations array and defaultTranslation.</span>

<span class="sd">        Args:</span>
<span class="sd">            js_bytes: Raw JavaScript code as bytes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TranslationConfig object or None if parsing fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ts</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">js_bytes</span><span class="p">)</span>

            <span class="c1"># Look for language configuration object by structure pattern</span>
            <span class="n">lang_config_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_language_config_object_bytes</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lang_config_object</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Extract translations array and defaultTranslation</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_translations_array_bytes</span><span class="p">(</span><span class="n">lang_config_object</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>
            <span class="n">default_translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_default_translation_bytes</span><span class="p">(</span><span class="n">lang_config_object</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">translations</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">default_translation</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">TranslationConfig</span><span class="p">(</span><span class="n">translations</span><span class="o">=</span><span class="n">translations</span><span class="p">,</span> <span class="n">default_translation</span><span class="o">=</span><span class="n">default_translation</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to parse JS language config: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_language_config_object_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find language configuration object by structure pattern (bytes version).</span>

<span class="sd">        Searches for objects containing:</span>
<span class="sd">        - &#39;translations&#39; array with objects having &#39;id&#39; and &#39;flag&#39; properties</span>
<span class="sd">        - &#39;defaultTranslation&#39; string property</span>

<span class="sd">        This method is resilient to variable name changes during minification and</span>
<span class="sd">        works with any variable assignment (var/const/let) or object property.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_node_text_local</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Local helper to extract node text from bytes.&quot;&quot;&quot;</span>
            <span class="n">node_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
            <span class="n">node_text</span> <span class="o">=</span> <span class="n">node_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="c1"># Remove quotes from string literals</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;property_identifier&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">node_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">node_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">node_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">node_text</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_language_config_object</span><span class="p">(</span><span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if this object looks like a language configuration.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">has_translations</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_default_translation</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">key_text</span> <span class="o">=</span> <span class="n">get_node_text_local</span><span class="p">(</span><span class="n">key_node</span><span class="p">)</span>

                <span class="c1"># Look for translations array</span>
                <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;translations&quot;</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                    <span class="c1"># Check if array contains objects with language-like structure</span>
                    <span class="k">if</span> <span class="n">is_translations_array_local</span><span class="p">(</span><span class="n">value_node</span><span class="p">):</span>
                        <span class="n">has_translations</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Look for defaultTranslation string</span>
                <span class="k">elif</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;defaultTranslation&quot;</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                    <span class="n">has_default_translation</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">has_translations</span> <span class="ow">and</span> <span class="n">has_default_translation</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_translations_array_local</span><span class="p">(</span><span class="n">array_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Local helper to check if array looks like translations array.&quot;&quot;&quot;</span>
            <span class="n">valid_entries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_objects</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">array_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                    <span class="n">total_objects</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">has_flag</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_node</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">key_text</span> <span class="o">=</span> <span class="n">get_node_text_local</span><span class="p">(</span><span class="n">key_node</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                            <span class="n">has_id</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;flag&quot;</span><span class="p">:</span>
                            <span class="n">has_flag</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">has_id</span> <span class="ow">and</span> <span class="n">has_flag</span><span class="p">:</span>
                        <span class="n">valid_entries</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Consider it a translations array if most objects have the expected structure</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">total_objects</span> <span class="o">*</span> <span class="mf">0.7</span>
            <span class="k">return</span> <span class="n">total_objects</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_entries</span> <span class="o">&gt;=</span> <span class="n">threshold</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">visit_node</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check all object literals for language config pattern</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">is_language_config_object</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">node</span>

            <span class="c1"># Also check variable assignments and property values</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;variable_declarator&quot;</span><span class="p">:</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">is_language_config_object</span><span class="p">(</span><span class="n">value_node</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">value_node</span>

            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;assignment_expression&quot;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">right</span> <span class="ow">and</span> <span class="n">right</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">is_language_config_object</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">right</span>

            <span class="c1"># Recursively search children</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">visit_node</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">result</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">visit_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_language_config_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find language configuration object by structure pattern (string version).</span>

<span class="sd">        Searches for objects containing:</span>
<span class="sd">        - &#39;translations&#39; array with objects having &#39;id&#39; and &#39;flag&#39; properties</span>
<span class="sd">        - &#39;defaultTranslation&#39; string property</span>

<span class="sd">        This method is resilient to variable name changes during minification and</span>
<span class="sd">        works with any variable assignment (var/const/let) or object property.</span>

<span class="sd">        Note: This is the legacy string-based version. Use _find_language_config_object_bytes</span>
<span class="sd">        for better Unicode support.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_node_text_local</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Local helper to extract node text.&quot;&quot;&quot;</span>
            <span class="n">node_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
            <span class="c1"># Remove quotes from string literals</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;property_identifier&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">node_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span>
                    <span class="ow">or</span> <span class="p">(</span><span class="n">node_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">node_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">node_text</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_language_config_object</span><span class="p">(</span><span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if this object looks like a language configuration.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">has_translations</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_default_translation</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">key_text</span> <span class="o">=</span> <span class="n">get_node_text_local</span><span class="p">(</span><span class="n">key_node</span><span class="p">)</span>

                <span class="c1"># Look for translations array</span>
                <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;translations&quot;</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                    <span class="c1"># Check if array contains objects with language-like structure</span>
                    <span class="k">if</span> <span class="n">is_translations_array_local</span><span class="p">(</span><span class="n">value_node</span><span class="p">):</span>
                        <span class="n">has_translations</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Look for defaultTranslation string</span>
                <span class="k">elif</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;defaultTranslation&quot;</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                    <span class="n">has_default_translation</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">has_translations</span> <span class="ow">and</span> <span class="n">has_default_translation</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_translations_array_local</span><span class="p">(</span><span class="n">array_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Local helper to check if array looks like translations array.&quot;&quot;&quot;</span>
            <span class="n">valid_entries</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">total_objects</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">array_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                    <span class="n">total_objects</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">has_flag</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">key_node</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="n">key_text</span> <span class="o">=</span> <span class="n">get_node_text_local</span><span class="p">(</span><span class="n">key_node</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                            <span class="n">has_id</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;flag&quot;</span><span class="p">:</span>
                            <span class="n">has_flag</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">has_id</span> <span class="ow">and</span> <span class="n">has_flag</span><span class="p">:</span>
                        <span class="n">valid_entries</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Consider it a translations array if most objects have the expected structure</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">total_objects</span> <span class="o">*</span> <span class="mf">0.7</span>
            <span class="k">return</span> <span class="n">total_objects</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_entries</span> <span class="o">&gt;=</span> <span class="n">threshold</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">visit_node</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check all object literals for language config pattern</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">is_language_config_object</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">node</span>

            <span class="c1"># Also check variable assignments and property values</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;variable_declarator&quot;</span><span class="p">:</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">is_language_config_object</span><span class="p">(</span><span class="n">value_node</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">value_node</span>

            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;assignment_expression&quot;</span><span class="p">:</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">right</span> <span class="ow">and</span> <span class="n">right</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="n">is_language_config_object</span><span class="p">(</span><span class="n">right</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">right</span>

            <span class="c1"># Recursively search children</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">visit_node</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">result</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">visit_node</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_translations_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an array looks like a translations array.</span>

<span class="sd">        Looks for array elements that are objects with &#39;id&#39; and &#39;flag&#39; properties,</span>
<span class="sd">        which is the signature of language configuration entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_entries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_objects</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">array_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                <span class="n">total_objects</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">has_id</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">has_flag</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key_node</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">key_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">key_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                        <span class="n">has_id</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;flag&quot;</span><span class="p">:</span>
                        <span class="n">has_flag</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">has_id</span> <span class="ow">and</span> <span class="n">has_flag</span><span class="p">:</span>
                    <span class="n">valid_entries</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Consider it a translations array if most objects have the expected structure</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">total_objects</span> <span class="o">*</span> <span class="mf">0.7</span>
        <span class="k">return</span> <span class="n">total_objects</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">valid_entries</span> <span class="o">&gt;=</span> <span class="n">threshold</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_translations_array_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract translations array from language configuration object (bytes version).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_node</span><span class="p">:</span>
                    <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">key_node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">key_node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
                    <span class="n">key_text</span> <span class="o">=</span> <span class="n">key_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;translations&quot;</span><span class="p">:</span>
                        <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_translations_array_bytes</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_default_translation_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract defaultTranslation from language configuration object (bytes version).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_node</span><span class="p">:</span>
                    <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">key_node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">key_node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
                    <span class="n">key_text</span> <span class="o">=</span> <span class="n">key_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key_text</span> <span class="o">==</span> <span class="s2">&quot;defaultTranslation&quot;</span><span class="p">:</span>
                        <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                            <span class="c1"># Remove quotes from string literal</span>
                            <span class="n">value_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">value_node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">value_node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
                            <span class="n">value_text</span> <span class="o">=</span> <span class="n">value_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">value_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_translations_array_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the translations array into Python list of dicts (bytes version).&quot;&quot;&quot;</span>
        <span class="n">translations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">array_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_translation_object_bytes</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">translation</span><span class="p">:</span>
                    <span class="n">translations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">translations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_translation_object_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a single translation object (bytes version).&quot;&quot;&quot;</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="p">:</span>
                    <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">key_node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">key_node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_js_value_bytes</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>
                    <span class="n">translation</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">translation</span> <span class="k">if</span> <span class="n">translation</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_js_value_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a JavaScript value node into Python equivalent (bytes version).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
            <span class="n">val_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
            <span class="n">val_text</span> <span class="o">=</span> <span class="n">val_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val_text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
            <span class="n">val_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
            <span class="n">val_text</span> <span class="o">=</span> <span class="n">val_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_text</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val_text</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                    <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                    <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="p">:</span>
                        <span class="n">key_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">key_node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">key_node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_js_value_bytes</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">)</span>
                        <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">):</span>
                    <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_js_value_bytes</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">js_bytes</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">arr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to raw text</span>
            <span class="n">val_bytes</span> <span class="o">=</span> <span class="n">js_bytes</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_translations_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract translations array from language configuration object.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_node</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">key_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;translations&quot;</span><span class="p">:</span>
                    <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_translations_array</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_default_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract defaultTranslation from language configuration object.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_node</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">key_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;defaultTranslation&quot;</span><span class="p">:</span>
                    <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
                        <span class="c1"># Remove quotes from string literal</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_translations_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse the translations array into Python list of dicts.&quot;&quot;&quot;</span>
        <span class="n">translations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">array_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_translation_object</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">translation</span><span class="p">:</span>
                    <span class="n">translations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">translations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_translation_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a single translation object.&quot;&quot;&quot;</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obj_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">key_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_js_value</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                    <span class="n">translation</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">translation</span> <span class="k">if</span> <span class="n">translation</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_js_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a JavaScript value node into Python equivalent.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
            <span class="n">val_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">val_text</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val_text</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;pair&quot;</span><span class="p">:</span>
                    <span class="n">key_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">)</span>
                    <span class="n">value_node</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">child_by_field_name</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key_node</span> <span class="ow">and</span> <span class="n">value_node</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">key_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_js_value</span><span class="p">(</span><span class="n">value_node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                        <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;,&quot;</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;[&quot;</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;]&quot;</span><span class="p">:</span>
                    <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_js_value</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">arr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to raw text</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_text</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_node_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract text content of a node, handling quoted strings.&quot;&quot;&quot;</span>
        <span class="n">node_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">start_byte</span> <span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">end_byte</span><span class="p">]</span>
        <span class="c1"># Remove quotes from string literals</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">node_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">node_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">node_text</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">node_text</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, MarPi82
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=7026087e"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    </body>
</html>